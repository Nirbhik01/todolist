<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ToDo List</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f3f4f6;
            padding: 2rem;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h2 {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        input,
        select,
        button {
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        .task-list {
            margin-top: 2rem;
        }

        .task {
            background-color: #f9fafb;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .badge {
            display: inline-block;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>ToDo List</h2>

        <form id="taskForm">
            <label for="">Task:</label>
            <input type="text" name="task_text" id="task_text" placeholder="Enter task description..." required />
            <label for="">Due Date:</label>
            <input type="date" name="due_date" id="due_date" placeholder="task duedate" />
            <label for="">Label:</label>
            <select name="task_label" id="task_label">
                <option value="WORK">Work</option>
                <option value="GROCERY">Grocery</option>
                <option value="STUDY">Study</option>
                <option value="OTHER">Other</option>
            </select>
            <label for="">Status:</label>
            <select name="task_status" id="task_status">
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>
            <button type="submit">Add Task</button>
        </form>

        <button id="showTasksBtn" style="margin-top: 1.5rem;">Show Tasks</button>

        <div id="filter" style="margin-top: 1rem;display:none;">
            <label>Filter by Label:</label>
            <select id="filterLabel">
                <option value="">All</option>
                <option value="WORK">Work</option>
                <option value="GROCERY">Grocery</option>
                <option value="STUDY">Study</option>
                <option value="OTHER">Other</option>
            </select><br>

            <label style="margin-left: 0rem;">Filter by Status:</label>
            <select id="filterStatus">
                <option value="">All</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>
            <br>
            <label>Filter by Due Date:</label>
            <input type="date" id="filterDueDate">
            <br>
            <button id="applyFiltersBtn">Apply Filters</button>
        </div>

        <div class="task-list" id="taskList">
            <!-- Tasks will appear here -->
        </div>
    </div>

    <script>
        document.getElementById('taskForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const text = document.getElementById('task_text').value;
            const label = document.getElementById('task_label').value;
            const status = document.getElementById('task_status').value;
            const dueDate = document.getElementById('due_date').value;

            fetch('/todo/add-task/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    task_text: text,
                    task_label: label,
                    task_status: status,
                    due_date: dueDate
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show task in the UI immediately
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task';
                        taskItem.innerHTML = `
                            <strong>${text}</strong><br>
                            <span class="badge">${label}</span>
                            <span class="badge">${status.replace('_', ' ')}</span>
                            <span class="badge">Due: ${dueDate || 'N/A'}</span>
                            `;
                        document.getElementById('taskList').prepend(taskItem);
                        document.getElementById('taskForm').reset();
                    } else {
                        alert("Failed to add task: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        document.getElementById('showTasksBtn').addEventListener('click', function () {

            fetch('/todo/tasks/')
                .then(response => response.json())
                .then(tasks => {
                    const taskList = document.getElementById('taskList');
                    taskList.innerHTML = '';

                    tasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task';
                        taskItem.innerHTML = `
                            <strong>${task.task_text}</strong><br>
                            <span class="badge">${task.task_label}</span>
                            <span class="badge">${task.task_status.replace('_', ' ')}</span>
                            <span class="badge">Due: ${task.due_date || 'N/A'}</span>
                            <button onclick="deleteTask(${task.id})" >❌</button>
                                `;
                        taskList.appendChild(taskItem);
                    });
                    document.getElementById("filter").style.display = "block";
                })
                .catch(error => {
                    console.error('Error fetching tasks:', error);
                });
        });
        document.getElementById('applyFiltersBtn').addEventListener('click', loadTasks);
        function loadTasks() {
            const label = document.getElementById('filterLabel').value;
            const status = document.getElementById('filterStatus').value;
            const dueDate = document.getElementById('filterDueDate').value;

            const params = [];
            let url = '/todo/filtertask/';
            if (label) params.push(`label=${label}`);
            if (status) params.push(`status=${status}`);
            if (dueDate) params.push(`due_date=${dueDate}`);
            if (params.length > 0) url += '?' + params.join('&');
            console.log(dueDate);

            fetch(url)
                .then(response => response.json())
                .then(tasks => {
                    const taskList = document.getElementById('taskList');
                    taskList.innerHTML = '';
                    tasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task';
                        taskItem.innerHTML = `
                        <strong>${task.task_text}</strong><br>
                        <span class="badge">${task.task_label}</span>
                        <span class="badge">${task.task_status.replace('_', ' ')}</span>
                        <span class="badge">Due: ${dueDate || 'N/A'}</span>
                        <button onclick="deleteTask(${task.id})" >❌</button>
                      `;
                        taskList.appendChild(taskItem);
                    });
                });
        }
        function deleteTask(taskId) {
            fetch(`/todo/delete-task/${taskId}/`, {
                method: 'DELETE',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('showTasksBtn').click();
                    } else {
                        alert("Delete failed: " + data.message);
                    }
                });
        }

    </script>
</body>

</html>